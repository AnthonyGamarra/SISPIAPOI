<div class="matrix-table-wrapper">
  <table class="matrix-table" border="1" cellpadding="5" cellspacing="0">
    <thead>
      <tr>
        <th>Posici√≥n presupuestaria</th>
        <th>Tipo de gasto</th>
        <th *ngFor="let mes of meses">{{ mes }}</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let row of data">
        <ng-template #recursive let-row let-nivel="nivel">
          <tr [class.child-row]="nivel > 0" [class.categoria-row]="!row.editable" [class.item-row]="row.editable">
            <td style="text-align: left;">
              <span [style.paddingLeft.px]="nivel * 30"></span>
              <button *ngIf="row.children" (click)="toggleExpand(row)" class="toggle-btn" [attr.aria-label]="row.expanded ? 'Contraer' : 'Expandir'">
                <span [ngClass]="{'icon-expanded': row.expanded, 'icon-collapsed': !row.expanded}">
                  <svg *ngIf="row.expanded" width="18" height="18" viewBox="0 0 20 20" style="vertical-align: middle;"><polyline points="5 12 10 7 15 12" fill="none" stroke="#1976d2" stroke-width="2"/></svg>
                  <svg *ngIf="!row.expanded" width="18" height="18" viewBox="0 0 20 20" style="vertical-align: middle;"><polyline points="5 8 10 13 15 8" fill="none" stroke="#1976d2" stroke-width="2"/></svg>
                </span>
              </button>
              <span [class.categoria-nombre]="!row.editable">{{ row.name }}</span>
            </td>
            <td>
              <ng-container *ngIf="row.editable">
                <select [(ngModel)]="row.tipoGasto">
                  <option *ngFor="let tipo of tiposGasto" [value]="tipo">{{ tipo }}</option>
                </select>
              </ng-container>
            </td>
            <td *ngFor="let mes of meses">
              <ng-container *ngIf="row.editable; else noedit">
                <input type="number" [(ngModel)]="row.meses[mes]" (input)="updateParentValues(row.parent)" style="width: 80px;" />
              </ng-container>
              <ng-template #noedit>{{ row.meses?.[mes] || 0 | number }}</ng-template>
            </td>
            <td>
              <span [class.categoria-total]="!row.editable">{{ calcularTotal(row) | number }}</span>
            </td>
          </tr>
          <ng-container *ngIf="row.expanded && row.children">
            <ng-container *ngFor="let child of row.children">
              <ng-container *ngTemplateOutlet="recursive; context: { $implicit: child, nivel: (nivel || 0) + 1 }"></ng-container>
            </ng-container>
          </ng-container>
        </ng-template>
        <ng-container *ngTemplateOutlet="recursive; context: { $implicit: row, nivel: 0 }"></ng-container>
      </ng-container>
    </tbody>
  </table>
</div>
