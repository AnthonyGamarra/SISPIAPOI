<div class="p-grid p-jc-center p-ai-center p-m-3">
  <div class="p-col-12">
    <p-card>
      <div class="p-d-flex p-jc-between p-ai-center p-mb-3">
        <h2>Administración de Planificación</h2>
        <div class="p-d-flex p-ai-center">
          <span class="p-mr-2">Año:</span>
          <p-dropdown [options]="years" [(ngModel)]="selectedYear" (onChange)="onYearChange()"
                      placeholder="Seleccionar Año" [showClear]="false"></p-dropdown>
          <p-button label="Nueva Modificatoria" icon="pi pi-plus" class="p-ml-3" (onClick)="openNewModificationDialog()"></p-button>
        </div>
      </div>

      <div *ngIf="getDependencyTypeNames().length === 0" class="p-text-center p-mt-5">
        <p>No hay formulaciones disponibles para el año {{selectedYear}}.</p>
      </div>

      <div *ngFor="let depTypeName of getDependencyTypeNames()">
        <p-fieldset [legend]="depTypeName" class="p-mt-4">
          <div *ngIf="!groupedFormulations[depTypeName] || Object.keys(groupedFormulations[depTypeName]).length === 0 || 
                      (getModificationNumbers(depTypeName).length === 1 && groupedFormulations[depTypeName][1]?.length === 0)" class="p-text-center p-my-3">
              <p>No hay formulaciones para este tipo de dependencia para el año {{selectedYear}}.</p>
          </div>

          <div *ngFor="let modificationNum of getModificationNumbers(depTypeName)">
            <ng-container *ngIf="groupedFormulations[depTypeName][modificationNum]!.length > 0">
              <h4 class="p-mt-4 p-mb-2">{{ modificationLabels[modificationNum] || 'Modificatoria Desconocida' }}</h4>
              <p-table [value]="groupedFormulations[depTypeName][modificationNum]" [paginator]="true" [rows]="10"
                       [tableStyle]="{'min-width': '50rem'}" styleClass="p-datatable-sm p-datatable-striped">
                <ng-template pTemplate="header">
                  <tr>
                    <th style="width: 30%;">Dependencia</th>
                    <th style="width: 15%;">Quarter</th>
                    <th style="width: 20%;">Estado</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-formulation>
                  <tr>
                    <td>{{ formulation.dependency?.name }}</td>
                    <td>{{ formulation.quarter }}</td>
                    <td>
                      <p-dropdown [options]="formulationStates" [(ngModel)]="formulation.formulationState!.idFormulationState"
                                  optionLabel="name" optionValue="idFormulationState"
                                  (onChange)="onStateChange(formulation, $event.value)"
                                  [style]="{'width': '100%'}"></p-dropdown>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td colspan="3" class="p-text-center">No hay formulaciones en este grupo.</td>
                  </tr>
                </ng-template>
              </p-table>
            </ng-container>
          </div>
        </p-fieldset>
      </div>
    </p-card>
  </div>
</div>

<p-dialog header="Nueva Modificatoria" [(visible)]="displayNewModificationDialog" [modal]="true" [style]="{width: '30vw'}" [draggable]="false" [resizable]="false">
  <div class="p-fluid">
    <div class="p-field">
      <label for="newQuarter">Trimestre:</label>
      <p-inputNumber id="newQuarter" [(ngModel)]="newModificationQuarter" [min]="1" [max]="4" [showButtons]="true"
                     placeholder="Ingrese trimestre (1-4)"></p-inputNumber>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (onClick)="displayNewModificationDialog = false"></p-button>
    <p-button label="Crear" icon="pi pi-check" (onClick)="addNewModification()"></p-button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>