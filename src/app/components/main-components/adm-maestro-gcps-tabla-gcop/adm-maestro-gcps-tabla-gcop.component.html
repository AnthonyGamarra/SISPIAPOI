<p-dialog [(visible)]="displayModal" header="Prestaciones de salud" [modal]="true" [closable]="!importLoading"
  [style]="{ width: '95vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false"
  [resizable]="true">
  <div class="mx-5">
    <div class="grid mt-3">
      <h2 class="py-0 col-12 md:col-7 lg:col-7">
        Carga de actividades - {{ currentFormulationType?.name }}:
      </h2>
      <!-- Support file controls for the formulation with the smallest id -->
      <div *ngIf="!loading && totalRecords > 0" class="col-12 md:col-5 lg:col-5 flex justify-content-end items-center gap-2">
        <!-- When uploading, hide 'Ver' and 'Actualizar' and show an uploading indicator -->
        <ng-container *ngIf="!supportFileUploading">
          <button pButton type="button" icon="pi pi-eye" label="Ver sustento" class="add-button"
            (click)="viewSupportFile()" [disabled]="!supportFileMetadata"></button>

          <!-- Show 'Subir sustento' only when there is no existing metadata AND formulation is not blocked -->
          <p-fileUpload #supportUpload mode="basic" chooseLabel="Subir sustento" [auto]="true" [customUpload]="true"
            (onSelect)="uploadSupportFile($event.files[0])" *ngIf="!supportFileMetadata && !isMinFormulationBlocked"
            [disabled]="!selectedSupportFormulationId" chooseIcon="pi pi-cloud-upload"
            class="p-button-sm"></p-fileUpload>

          <!-- Show 'Actualizar' only when metadata exists AND formulation is not blocked -->
          <p-fileUpload #supportUpdate mode="basic" chooseLabel="Actualizar sustento" [auto]="true"
            [customUpload]="true" (onSelect)="updateSupportFile($event.files[0])"
            *ngIf="supportFileMetadata && !isMinFormulationBlocked" chooseIcon="pi pi-cloud-upload"
            class="p-button-sm"></p-fileUpload>
        </ng-container>

        <ng-container *ngIf="supportFileUploading">
          <button pButton type="button" label="Subiendo..." icon="pi pi-spin pi-spinner" class="p-button-text"
            disabled="true"></button>
        </ng-container>
      </div>
      <span class="col-5 md:col-1 lg:col-1 my-auto">
        <label class="block text-sm font-medium mb-1">Año:</label>
        <p-select [options]="years" [(ngModel)]="selectedYear" (onChange)="onYearChange()" placeholder="Seleccionar Año"
          [showClear]="false" class="mx-2"></p-select>
      </span>
      <span class="col-7 md:col-2 lg:col-2 my-auto">
        <label class="block text-sm font-medium mb-1">Etapa:</label>
        <p-select [options]="modificationOptions" optionLabel="label" optionValue="value"
          [(ngModel)]="selectedModification" (onChange)="onModificationChange()" placeholder="Seleccionar Etapa"
          [showClear]="false"></p-select>
      </span>
      <span class="col-6 md:col-2 lg:col-2 my-auto"
        *ngIf="minFormulationStateLabel || canChangeState || minFormulationYear">
        <label class="block text-sm font-medium mb-1">Estado:</label>
        <input pInputText [ngModel]="minFormulationStateLabel" [disabled]="true" class="mx-2" />
      </span>
      <span *ngIf="!loading && totalRecords > 0" class="col-12 md:col-7 lg:col-7 my-auto flex justify-content-end gap-2">
        <button *ngIf="!isMinFormulationBlocked" pButton label="Exportar Plantilla" icon="pi pi-download"
          class="add-button" (click)="exportHealthActivityTemplate()"
          title="Descargar plantilla Excel para actividades de salud">
        </button>
        <button *ngIf="!isMinFormulationBlocked" pButton
          [label]="hasActiveFormulations() ? 'Actualizar datos' : 'Importar Plantilla'" icon="pi pi-upload"
          class="add-button" (click)="onImportTemplateClick()"
          [title]="hasActiveFormulations() ? 'Actualizar actividades existentes desde plantilla Excel' : 'Importar actividades desde plantilla Excel'">
        </button>
        <!-- <button pButton *ngIf="hasActiveFormulations()" label="Crear nueva modificatoria" icon="pi pi-plus"
          class="add-button" (click)="onCreateNewModificationClick()"
          title="Crear nueva modificatoria a partir de una plantilla Excel">
        </button> -->
        <!-- Change state button for min formulation -->
        <button *ngIf="canChangeState && selectedSupportFormulationId" pButton type="button" label="Cambiar estado"
          icon="pi pi-pencil" class="add-button" (click)="showChangeStateModal = true"></button>
      </span>
    </div>
    <!-- Dialog para cambiar estado de la formulación mínima -->
    <p-dialog header="Cambiar Estado de Formulación" [(visible)]="showChangeStateModal" [modal]="true"
      [resizable]="true" class="dialog-header-state" draggable="false">
      <div class="p-fluid">
        <div class="p-field mt-5">
          <label for="state" class="mr-5">Estado Actual:</label>
          <input pInputText id="currentState" [ngModel]="minFormulationStateLabel" [disabled]="true" />
        </div>
        <div class="p-field mt-3">
          <label for="newState" class="mr-5">Nuevo Estado:</label>
          <p-select id="newState" [options]="formulationStateOptions" [(ngModel)]="selectedFormulationState"
            placeholder="Seleccione un nuevo estado" optionLabel="name" optionValue="idFormulationState"
            appendTo="body"></p-select>
        </div>
      </div>
      <ng-template pTemplate="footer">
        <button pButton label="Cancelar" icon="pi pi-times" styleClass="p-button-text"
          (click)="showChangeStateModal = false" class="cancel-button"></button>
        <button pButton label="Guardar" icon="pi pi-check" (click)="changeFormulationState()"
          [disabled]="!selectedFormulationState" class="add-button"></button>
      </ng-template>
    </p-dialog>

    <div class="formulacion-salud-od-tabla">

      <!-- Filtro por Dependencia -->
      <div *ngIf="!loading && totalRecords > 0" class="filter-section mb-1 px-2 py-1 bg-gray-50 rounded-lg">
        <h4 class="text-md font-semibold text-gray-700 mb-2">Filtrar por Dependencia</h4>
        <div class="flex items-center gap-2">
          <p-select [options]="dependencyOptions" [(ngModel)]="idDependency" (onChange)="applyFilter()"
            placeholder="Seleccionar Dependencia" [filter]="true" class="flex-1"></p-select>
          <p-button label="Limpiar Filtro" icon="pi pi-times" (onClick)="clearDependencyFilter()"
            [disabled]="!idDependency" styleClass="p-button-secondary"></p-button>
        </div>
      </div>
      <!-- Filtro por Centro Asistencial -->
      <div *ngIf="!loading && totalRecords > 0" class="filter-section mb-1 px-2 py-1 bg-gray-50 rounded-lg">
        <h4 class="text-md font-semibold text-gray-700 mb-2">Filtrar por Centro Asistencial</h4>
        <div class="flex items-center gap-2">
          <p-select [options]="desCenSesOptions" [(ngModel)]="selectedDesCenSes" (onChange)="applyFilter()"
            placeholder="Seleccionar Centro Asistencial" [filter]="true" class="flex-1" [disabled]="!idDependency"></p-select>
          <p-button label="Limpiar Filtro" icon="pi pi-times" (onClick)="clearFilter()" [disabled]="!selectedDesCenSes"
            styleClass="p-button-secondary"></p-button>
        </div>
      </div>
      <!-- Total General (zona superior) -->
      <!-- Vista: switch Trimestral / Mensual -->
      <div *ngIf="!loading && totalRecords > 0" class="view-toggle m-3 flex gap-2 items-center">
        <button pButton label="Trimestral" (click)="setViewMode('trimestral')" [disabled]="isTrimestral"
          class="add-button"></button>
        <button pButton label="Mensual" (click)="setViewMode('mensual')" [disabled]="isMensual"
          class="add-button"></button>
        <!-- Export buttons -->
        <div class="ml-4 flex items-center gap-2">
          <button pButton *ngIf="isTrimestral" label="Exportar Trimestral Consol." icon="pi pi-file-excel"
            (click)="exportTrimestralConsolidadoNivel('ALL')" class="add-button"></button>
          <button pButton *ngIf="isTrimestral" label="Exportar Trimestral Detallado" icon="pi pi-file-excel"
            (click)="exportTrimestralDetalladoNivel('ALL')" class="add-button"></button>
          <button pButton *ngIf="!isTrimestral" label="Exportar Mensual Consol." icon="pi pi-file-excel"
            (click)="exportMensualConsolidadoNivel('ALL')" class="add-button"></button>
          <button pButton *ngIf="!isTrimestral" label="Exportar Mensual Detallado" icon="pi pi-file-excel"
            (click)="exportMensualDetalladoNivel('ALL')" class="add-button"></button>
          <!-- Quick per-level exports -->
          <!-- <div class="ml-2">
        <small class="text-sm">Nivel:</small>
        <p-button label="I" (onClick)="exportTrimestralConsolidadoNivel('I')" styleClass="p-button-text"></p-button>
        <p-button label="II" (onClick)="exportTrimestralConsolidadoNivel('II')" styleClass="p-button-text"></p-button>
        <p-button label="III" (onClick)="exportTrimestralConsolidadoNivel('III')" styleClass="p-button-text"></p-button>
      </div> -->
        </div>
      </div>

      <!-- Loader de filtrado -->
      <div *ngIf="filtering" class="text-center p-4">
        <p-progressSpinner [style]="{'width': '40px', 'height': '40px'}" strokeWidth="4"></p-progressSpinner>
        <p class="mt-2 text-gray-600">Filtrando datos...</p>
      </div>

      <!-- Estado de carga -->
      <div *ngIf="loading" class="text-center p-6">
        <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
        <p class="mt-3 text-gray-600">Cargando datos de salud...</p>
      </div>

      <!-- Mensaje sin datos -->
      <div
        *ngIf="!loading && groupedHealthDataNivelI.length === 0 && groupedHealthDataNivelII.length === 0 && groupedHealthDataNivelIII.length === 0"
        class="text-center p-6">
        <h3 class="text-lg font-semibold text-gray-600">No hay actividades de salud registradas para esta formulación.
        </h3>
      </div>

      <!-- Tabla Nivel I -->
      <!-- Resumen Total Presupuesto -->
      <div *ngIf="!loading && groupedHealthDataNivelI.length > 0 && isTrimestral" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel I</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelI" dataKey="id" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px;"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr class="font-bold bg-gray-100">
              <td colspan="8" class="text-right">Total Nivel I:</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelI.t1) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelI.t2) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelI.t3) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelI.t4) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelI.total) }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'I')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'I') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(row.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(row.presupuesto.total) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'I')">
              <td colspan="14">
                <p-table class="fixed-table" [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px;"></th>
              <!-- <th style="min-width: 80px; max-width: 80px;">O.E. (código)</th>
                  <th style="min-width: 80px; max-width: 80px;">A.E. (código)</th> -->
              <!-- <th style="min-width: 300px; max-width: 300px;">Centro Asistencial</th> -->
              <th style="min-width: 330px; max-width: 330px">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td></td>
              <!-- <td>
                    <span pTooltip="{{ detail.objetivoEstrategico.nombre }}" tooltipPosition="top">
                      {{ detail.objetivoEstrategico.codigo }}
                    </span>
                  </td>
                  <td>
                    <span pTooltip="{{ detail.accionEstrategica.nombre }}" tooltipPosition="top">
                      {{ detail.accionEstrategica.codigo }}
                    </span>
                  </td> -->
              <!-- <td>{{ detail.desCenSes }}</td> -->
              <td>{{ detail.accionEstrategica.nombre }}</td>
              <td>{{ detail.unidadMedida }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(detail.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="13" class="text-center p-4">
              No se encontraron actividades de Nivel I para mostrar.
            </td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <!-- Tabla Nivel I - Mensual -->
      <div *ngIf="!loading && groupedHealthDataNivelIMensual.length > 0 && isMensual" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel I - Mensual</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelIMensual" dataKey="id" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <!-- Month metas columns -->
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Meta</th>
              <!-- Total metas placed immediately after Diciembre Meta -->
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <!-- Month presupuesto columns -->
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 140px; max-width: 140px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'I')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'I') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <!-- Render metas (12) then Total Metas immediately after metas, then presupuesto (12) -->
              <td *ngFor="let m of row.meses" class="montos">{{ formatNumber(m.metas) }}</td>
              <td class="montos font-bold">{{ formatNumber(sumMesMetas(row)) }}</td>
              <td *ngFor="let m of row.meses" class="montos">{{ formatCurrency(m.presupuesto) }}</td>
              <td class="montos font-bold">{{ formatCurrency(sumMesPresupuesto(row)) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'I')">
              <td colspan="29">
                <p-table class="fixed-table" [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <!-- detail header: metas 12, then total metas, then presupuesto 12, then total presupuesto -->
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Meta</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 140px; max-width: 140px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td style="min-width: 50px; max-width: 50px"></td>
              <td style="min-width: 330px; max-width: 330px">{{ detail.accionEstrategica.nombre }}</td>
              <td style="min-width: 200px; max-width: 200px">{{ detail.unidadMedida }}</td>
              <!-- Convert detail trimestral to monthly evenly: metas (12), then total metas, then presupuesto (12), then total presupuesto -->
              <td *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]" class="montos">{{
                formatNumber(monthlyMetaForDetail(detail, mIndex)) }}</td>
              <td class="montos font-bold">{{ formatNumber(detail.metas.total) }}</td>
              <td *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]" class="montos">{{
                formatCurrency(monthlyBudgetForDetail(detail, mIndex)) }}</td>
              <td class="montos font-bold">{{ formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr class="font-bold bg-gray-100">
            <td colspan="16" class="text-right">Total Nivel I:</td>
            <td *ngFor="let i of [0,1,2,3,4,5,6,7,8,9,10,11]" class="text-right">{{
              formatCurrency(totalPresupuestoMensualNivelI[i]) }}</td>
            <td class="text-right">{{ formatCurrency(sumArray(totalPresupuestoMensualNivelI)) }}</td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <!-- Tabla Nivel II -->
      <div *ngIf="!loading && groupedHealthDataNivelII.length > 0 && isTrimestral" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel II</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelII" dataKey="id" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr class="font-bold bg-gray-100">
              <td colspan="8" class="text-right">Total Nivel II:</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelII.t1) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelII.t2) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelII.t3) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelII.t4) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelII.total) }}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'II')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'II') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(row.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(row.presupuesto.total) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'II')">
              <td colspan="14">
                <p-table class="fixed-table" [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px"></th>
              <!-- <th style="min-width: 80px; max-width: 80px;">O.E. (código)</th>
                  <th style="min-width: 80px; max-width: 80px;">A.E. (código)</th>
                  <th style="min-width: 170px; max-width: 170px;">Centro Asistencial</th> -->
              <th style="min-width: 330px; max-width: 330px">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td></td>
              <!-- <td>
                    <span pTooltip="{{ detail.objetivoEstrategico.nombre }}" tooltipPosition="top">
                      {{ detail.objetivoEstrategico.codigo }}
                    </span>
                  </td>
                  <td>
                    <span pTooltip="{{ detail.accionEstrategica.nombre }}" tooltipPosition="top">
                      {{ detail.accionEstrategica.codigo }}
                    </span>
                  </td>
                  <td>{{ detail.desCenSes }}</td> -->
              <td>{{ detail.accionEstrategica.nombre }}</td>
              <td>{{ detail.unidadMedida }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(detail.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="13" class="text-center p-4">
              No se encontraron actividades de Nivel II para mostrar.
            </td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <!-- Tabla Nivel II - Mensual -->
      <div *ngIf="!loading && groupedHealthDataNivelIIMensual.length > 0 && isMensual" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel II - Mensual</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelIIMensual" dataKey="id" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Meta</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 140px; max-width: 140px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'II')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'II') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <td *ngFor="let m of row.meses" class="montos">{{ formatNumber(m.metas) }}</td>
              <td class="montos font-bold">{{ formatNumber(sumMesMetas(row)) }}</td>
              <td *ngFor="let m of row.meses" class="montos">{{ formatCurrency(m.presupuesto) }}</td>
              <td class="montos font-bold">{{ formatCurrency(sumMesPresupuesto(row)) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'II')">
              <td colspan="29">
                <p-table class="fixed-table" [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 100px; max-width: 100px">{{mName}} Meta</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td style="min-width: 50px; max-width: 50px"></td>
              <td style="min-width: 330px; max-width: 330px">{{ detail.accionEstrategica.nombre }}</td>
              <td style="min-width: 200px; max-width: 200px">{{ detail.unidadMedida }}</td>
              <td style="min-width: 120px; max-width: 120px" *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]"
                class="montos">{{
                formatNumber(monthlyMetaForDetail(detail, mIndex)) }}</td>
              <td style="min-width: 170px; max-width: 170px" class="montos font-bold">{{
                formatNumber(detail.metas.total) }}</td>
              <td style="min-width: 140px; max-width: 140px" *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]"
                class="montos">{{
                formatCurrency(monthlyBudgetForDetail(detail, mIndex)) }}</td>
              <td style="min-width: 240px; max-width: 240px" class="montos font-bold">{{
                formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr class="font-bold bg-gray-100">
            <td colspan="16" class="text-right">Total Nivel II:</td>
            <td *ngFor="let i of [0,1,2,3,4,5,6,7,8,9,10,11]" class="text-right">{{
              formatCurrency(totalPresupuestoMensualNivelII[i]) }}</td>
            <td class="text-right">{{ formatCurrency(sumArray(totalPresupuestoMensualNivelII)) }}</td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <!-- Tabla Nivel III -->
      <div *ngIf="!loading && groupedHealthDataNivelIII.length > 0 && isTrimestral" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel III</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelIII" dataKey="id" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr class="font-bold bg-gray-100">
              <td colspan="8" class="text-right">Total Nivel III:</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelIII.t1) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelIII.t2) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelIII.t3) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelIII.t4) }}</td>
              <td class="text-right">{{ formatCurrency(totalPresupuestoNivelIII.total) }}</td>
            </tr>
          </ng-template>
          <!-- Total General -->
          <div *ngIf="!loading" class="mb-6">
            <div class="p-4 bg-blue-50 rounded-lg flex flex-wrap gap-4 items-center justify-end">
              <span class="font-bold text-lg">Total General:</span>
              <ng-container *ngIf="isTrimestral">
                <span>T1: <span class="font-bold">{{ formatCurrency(totalPresupuestoGeneral.t1) }}</span></span>
                <span>T2: <span class="font-bold">{{ formatCurrency(totalPresupuestoGeneral.t2) }}</span></span>
                <span>T3: <span class="font-bold">{{ formatCurrency(totalPresupuestoGeneral.t3) }}</span></span>
                <span>T4: <span class="font-bold">{{ formatCurrency(totalPresupuestoGeneral.t4) }}</span></span>
                <span>Total: <span class="font-bold">{{ formatCurrency(totalPresupuestoGeneral.total) }}</span></span>
              </ng-container>
              <ng-container *ngIf="isMensual">
                <!-- compute monthly totals by summing mensual grouped arrays across levels -->
                <ng-container
                  *ngIf="groupedHealthDataNivelIMensual || groupedHealthDataNivelIIMensual || groupedHealthDataNivelIIIMensual">
                  <span *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]">M{{mIndex+1}}: <span class="font-bold">{{
                      formatCurrency(monthlyTotalForMonth(mIndex)) }}</span></span>
                  <span>Total: <span class="font-bold">{{ formatCurrency(monthlyTotalAll()) }}</span></span>
                </ng-container>
              </ng-container>
            </div>
          </div>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'III')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'III') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(row.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(row.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(row.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(row.presupuesto.total) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'III')">
              <td colspan="14">
                <p-table [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px;"></th>
              <!-- <th style="min-width: 80px; max-width: 80px;">O.E. (código)</th>
                  <th style="min-width: 80px; max-width: 80px;">A.E. (código)</th>
                  <th style="min-width: 170px; max-width: 170px;">Centro Asistencial</th> -->
              <th style="min-width: 330px; max-width: 330px;">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px;">Unidad de medida</th>
              <th style="min-width: 160px; max-width: 160px;">I Trimestre</th>
              <th style="min-width: 160px; max-width: 160px;">II Trimestre</th>
              <th style="min-width: 160px; max-width: 160px;">III Trimestre</th>
              <th style="min-width: 160px; max-width: 160px;">IV Trimestre</th>
              <th style="min-width: 170px; max-width: 170px;">Total Metas</th>
              <th style="min-width: 210px; max-width: 210px;">Presupuesto T1 S/.</th>
              <th style="min-width: 210px; max-width: 210px;">Presupuesto T2 S/.</th>
              <th style="min-width: 210px; max-width: 210px;">Presupuesto T3 S/.</th>
              <th style="min-width: 210px; max-width: 210px;">Presupuesto T4 S/.</th>
              <th style="min-width: 240px; max-width: 240px;">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td></td>
              <!-- <td>
                    <span pTooltip="{{ detail.objetivoEstrategico.nombre }}" tooltipPosition="top">
                      {{ detail.objetivoEstrategico.codigo }}
                    </span>
                  </td>
                  <td>
                    <span pTooltip="{{ detail.accionEstrategica.nombre }}" tooltipPosition="top">
                      {{ detail.accionEstrategica.codigo }}
                    </span>
                  </td>
                  <td>{{ detail.desCenSes }}</td> -->
              <td>{{ detail.accionEstrategica.nombre }}</td>
              <td>{{ detail.unidadMedida }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre1) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre2) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre3) }}</td>
              <td class="montos">{{ formatNumber(detail.metas.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatNumber(detail.metas.total) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre1) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre2) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre3) }}</td>
              <td class="montos">{{ formatCurrency(detail.presupuesto.trimestre4) }}</td>
              <td class="montos font-bold">{{ formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="13" class="text-center p-4">
              No se encontraron actividades de Nivel III para mostrar.
            </td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <!-- Tabla Nivel III - Mensual -->
      <div *ngIf="!loading && groupedHealthDataNivelIIIMensual.length > 0 && isMensual" class="table-container mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Nivel III - Mensual</h3>
        <p-table class="fixed-table" [value]="groupedHealthDataNivelIIIMensual" dataKey="id" [size]="'small'"
          stripedRows showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="500px"
          columnResizeMode="expand" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Familia</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Meta</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 140px; max-width: 140px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <td>
                <button type="button" pButton pRipple (click)="toggleRowExpansion(row.id, 'III')"
                  class="p-button-text p-button-rounded p-button-plain"
                  [icon]="isRowExpanded(row.id, 'III') ? 'pi pi pi-minus' : 'pi pi-plus'">
                </button>
              </td>
              <td class="font-bold text-lg">{{ row.familia }}</td>
              <td>Atenciones</td>
              <td *ngFor="let m of row.meses" class="montos">{{ formatNumber(m.metas) }}</td>
              <td class="montos font-bold">{{ formatNumber(sumMesMetas(row)) }}</td>
              <td *ngFor="let m of row.meses" class="montos">{{ formatCurrency(m.presupuesto) }}</td>
              <td class="montos font-bold">{{ formatCurrency(sumMesPresupuesto(row)) }}</td>
            </tr>
            <tr *ngIf="isRowExpanded(row.id, 'III')">
              <td colspan="29">
                <p-table class="fixed-table" [value]="row.detalles" [size]="'small'" stripedRows showGridlines>
                  <ng-template pTemplate="header">
            <tr class="cabecera-detalle">
              <th style="min-width: 50px; max-width: 50px"></th>
              <th style="min-width: 330px; max-width: 330px">Nombre de Actividad</th>
              <th style="min-width: 200px; max-width: 200px">Unidad de medida</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 100px; max-width: 100px">{{mName}} Meta</th>
              <th style="min-width: 170px; max-width: 170px">Total Metas</th>
              <th
                *ngFor="let mName of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']"
                style="min-width: 120px; max-width: 120px">{{mName}} Presupuesto S/.</th>
              <th style="min-width: 240px; max-width: 240px">Total Presupuesto S/.</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-detail>
            <tr>
              <td style="min-width: 50px; max-width: 50px"></td>
              <td style="min-width: 330px; max-width: 330px">{{ detail.accionEstrategica.nombre }}</td>
              <td style="min-width: 200px; max-width: 200px">{{ detail.unidadMedida }}</td>
              <td style="min-width: 120px; max-width: 120px" *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]"
                class="montos">{{
                formatNumber(monthlyMetaForDetail(detail, mIndex)) }}</td>
              <td style="min-width: 170px; max-width: 170px" class="montos font-bold">{{
                formatNumber(detail.metas.total) }}</td>
              <td style="min-width: 140px; max-width: 140px" *ngFor="let mIndex of [0,1,2,3,4,5,6,7,8,9,10,11]"
                class="montos">{{
                formatCurrency(monthlyBudgetForDetail(detail, mIndex)) }}</td>
              <td style="min-width: 240px; max-width: 240px" class="montos font-bold">{{
                formatCurrency(detail.presupuesto.total) }}</td>
            </tr>
          </ng-template>
        </p-table>
        </td>
        </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr class="font-bold bg-gray-100">
            <td colspan="16" class="text-right">Total Nivel III:</td>
            <td *ngFor="let i of [0,1,2,3,4,5,6,7,8,9,10,11]" class="text-right">{{
              formatCurrency(totalPresupuestoMensualNivelIII[i]) }}</td>
            <td class="text-right">{{ formatCurrency(sumArray(totalPresupuestoMensualNivelIII)) }}</td>
          </tr>
        </ng-template>
        </p-table>
      </div>

      <div *ngIf="!loading && totalPresupuestoGeneral.total" class="table-container mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Total Presupuesto</h3>
        <p-table class="fixed-table" [value]="[totalPresupuestoGeneral]" dataKey="total" [size]="'small'" stripedRows
          showGridlines [resizableColumns]="true" [scrollable]="true" scrollHeight="100px" columnResizeMode="expand"
          responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr class="cabecera-total">
              <ng-container *ngIf="isTrimestral">
                <th style="min-width: 50px; max-width: 50px;"></th>
                <th style="min-width: 330px; max-width: 330px;"></th>
                <th style="min-width: 200px; max-width: 200px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 170px; max-width: 170px;"></th>
                <th style="min-width: 210px; max-width: 210px;">Presupuesto T1 S/.</th>
                <th style="min-width: 210px; max-width: 210px;">Presupuesto T2 S/.</th>
                <th style="min-width: 210px; max-width: 210px;">Presupuesto T3 S/.</th>
                <th style="min-width: 210px; max-width: 210px;">Presupuesto T4 S/.</th>
                <th style="min-width: 240px; max-width: 240px;">Total Presupuesto S/.</th>
              </ng-container>
              <ng-container *ngIf="isMensual">
                <!-- show month-labeled presupuesto columns (Enero..Diciembre Presupuesto S/.) -->
                <th style="min-width: 50px; max-width: 50px;"></th>
                <th style="min-width: 330px; max-width: 330px;"></th>
                <th style="min-width: 200px; max-width: 200px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 160px; max-width: 160px;"></th>
                <th style="min-width: 170px; max-width: 170px;"></th>
                <th style="min-width: 160px; max-width: 160px;">Enero Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Febrero Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Marzo Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Abril Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Mayo Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Junio Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Julio Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Agosto Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Septiembre Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Octubre Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Noviembre Presupuesto S/.</th>
                <th style="min-width: 160px; max-width: 160px;">Diciembre Presupuesto S/.</th>
                <th style="min-width: 240px; max-width: 240px;">Total Presupuesto S/.</th>
              </ng-container>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row>
            <tr>
              <ng-container *ngIf="isTrimestral">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="montos font-bold">{{ formatCurrency(row.t1) }}</td>
                <td class="montos font-bold">{{ formatCurrency(row.t2) }}</td>
                <td class="montos font-bold">{{ formatCurrency(row.t3) }}</td>
                <td class="montos font-bold">{{ formatCurrency(row.t4) }}</td>
                <td class="montos font-bold">{{ formatCurrency(row.total) }}</td>
              </ng-container>
              <ng-container *ngIf="isMensual">
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(0)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(1)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(2)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(3)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(4)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(5)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(6)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(7)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(8)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(9)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(10)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalForMonth(11)) }}</td>
                <td class="montos font-bold">{{ formatCurrency(monthlyTotalAll()) }}</td>
              </ng-container>
            </tr>
          </ng-template>
        </p-table>
      </div>

    </div>

    <!-- Import Preview Modal -->
    <p-dialog [(visible)]="showImportPreviewModal" header="Vista Previa de Importación" [modal]="true"
      [closable]="!importLoading" [style]="{ width: '40vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }"
      [draggable]="false" [resizable]="false">

      <div class="import-preview-content">
        <!-- File Selection -->
        <div class="file-section mb-1" *ngIf="!importFile">
          <h4>Seleccionar Archivo Excel</h4>
          <input type="file" accept=".xlsx,.xls" (change)="onFileChange($event)" class="form-control"
            style="padding: 10px; border: 2px dashed #ccc; border-radius: 5px; width: 100%;">
          <p class="text-muted mt-2" style="font-size: 0.9em;">
            <i class="pi pi-info-circle"></i> Selecciona un archivo Excel (.xlsx o .xls)
          </p>
        </div>

        <!-- File Selected Message -->
        <div class="file-selected mb-1" *ngIf="importFile && !previewLoading && importPreviewData.length === 0">
          <div class="alert alert-info"
            style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px;">
            <div style="display: flex; align-items: center;">
              <i class="pi pi-file" style="margin-right: 8px; color: #2196f3;"></i>
              <div>
                <strong>Archivo seleccionado:</strong> {{ importFile.name }}
                <br>
                <small class="text-muted">Tamaño: {{ (importFile.size / 1024 / 1024).toFixed(2) }} MB</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Loading -->
        <div class="preview-loading text-center" *ngIf="previewLoading" style="padding: 20px;">
          <p-progressSpinner [style]="{'width': '40px', 'height': '40px'}"></p-progressSpinner>
          <p class="mt-3" style="font-size: 1.1em; font-weight: 500;">
            <strong>Cargando actividades...</strong>
          </p>
          <p class="text-muted" style="font-size: 0.9em;">
            Procesando archivo Excel para mostrar vista previa
          </p>
        </div>

        <!-- Preview Data -->
        <div class="preview-data" *ngIf="!previewLoading && importPreviewData.length > 0 && !importLoading">
          <div class="alert alert-success my-3">
            <strong>✓ Archivo procesado correctamente</strong>
          </div>
          <h4>Vista Previa de Importación</h4>
          <p class="text-muted mb-3">Se encontraron las siguientes dependencias y actividades:</p>

          <p-table [value]="importPreviewData" [tableStyle]="{'min-width': '100%'}">
            <ng-template pTemplate="header">
              <tr>
                <th>Dependencia</th>
                <th class="text-center">Cantidad de Actividades</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.dependencyName }}</td>
                <td class="text-center">{{ item.activityCount }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="summary">
              <div class="text-right">
                <strong>Total de actividades: {{ getTotalActivities() }}</strong>
              </div>
            </ng-template>
          </p-table>
        </div>

        <!-- Import Progress - DENTRO DEL MODAL -->
        <div class="import-progress text-center" *ngIf="importLoading" style="padding: 20px;">
          <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
          <div class="mt-3">
            <div class="progress-bar-container" style="width: 100%; max-width: 550px; margin: 0 auto;">
              <div class="progress-bar"
                style="height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                <div style="height: 100%; background: #4caf50; transition: width 0.3s ease;"
                  [style.width.%]="importProgress"></div>
              </div>
              <div class="mt-3" style="font-size: 1.1em; font-weight: 500;">
                <strong>Importación de actividades... {{importProgress}}%</strong>
              </div>
              <div class="text-muted" style="font-size: 0.9em;">
                {{importProcessed}} de {{importTotal}} actividades procesadas
              </div>
              <div class="mt-2" style="font-size: 0.8em; color: #666; font-style: italic;">
                <i class="pi pi-shield" style="margin-right: 4px;"></i>
                Procesando una actividades para garantizar integridad de datos - No cerrar este diálogo o actualizar la
                página
              </div>
              <div class="mt-2" style="font-size: 0.7em; color: #666; font-style: italic;">
                <i class="pi pi-clock" style="margin-right: 4px;"></i>
                Puede tardar varios minutos dependiendo del tamaño del archivo y la cantidad de actividades
              </div>
            </div>
          </div>
        </div>

        <!-- No Data Message -->
        <div class="no-data text-center" *ngIf="!previewLoading && importPreviewData.length === 0 && importFile">
          <div class="alert alert-warning">
            <strong>⚠ No se encontraron datos válidos</strong>
            <p class="mb-0">El archivo seleccionado no contiene datos de actividades válidos.</p>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <ng-template pTemplate="footer">
        <div class="flex justify-content-between gap-2">
          <p-button label="Cancelar" icon="pi pi-times" severity="secondary" [disabled]="importLoading"
            (click)="cancelImport()">
          </p-button>

          <div class="flex gap-2">
            <!-- <p-button 
          label="Seleccionar Otro Archivo" 
          icon="pi pi-file" 
          severity="info"
          *ngIf="importFile && !importLoading"
          (click)="resetFileSelection()">
        </p-button> -->

            <p-button label="Confirmar Importación" icon="pi pi-check" severity="success"
              [disabled]="!importFile || importPreviewData.length === 0 || previewLoading || importLoading"
              (click)="confirmImport()">
            </p-button>
          </div>
        </div>
      </ng-template>
    </p-dialog>

    <!-- Support file viewer dialog -->
    <p-dialog [(visible)]="showSupportFileViewer" header="Sustento" [modal]="true" [closable]="true"
      (onHide)="closeSupportFileViewer()" [style]="{width: '80vw', height: '80vh'}" [draggable]="false"
      [resizable]="true">
      <div *ngIf="supportDocumentUrl" style="height:70vh;">
        <!-- Use iframe for better in-dialog rendering of blob URLs (PDFs) -->
        <iframe [src]="supportDocumentUrl | safeUrl" width="100%" height="100%" frameborder="0"></iframe>
      </div>
      <div *ngIf="!supportDocumentUrl" class="p-2">No se encontró documento para mostrar.</div>
      <ng-template pTemplate="footer">
        <p-button label="Cerrar" icon="pi pi-times" (onClick)="closeSupportFileViewer()"
          class="p-button-text"></p-button>
        <a *ngIf="supportDocumentUrl" [href]="supportDocumentUrl" target="_blank"
          class="ml-2 p-button p-component p-button-outlined">Abrir en nueva pestaña</a>
      </ng-template>
    </p-dialog>

    <!-- New Modification Modal -->
    <p-dialog [(visible)]="showNewModificationModal" header="Crear Nueva Modificatoria" [modal]="true"
      [closable]="!newModificationLoading" [style]="{ width: '40vw' }"
      [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false" [resizable]="false">

      <div class="new-modification-content">
        <!-- File Selection -->
        <div class="file-section mb-1" *ngIf="!newModificationFile">
          <h4>Seleccionar Archivo Excel</h4>
          <input type="file" accept=".xlsx,.xls" (change)="onNewModificationFileChange($event)" class="form-control"
            style="padding: 10px; border: 2px dashed #ccc; border-radius: 5px; width: 100%;">
          <p class="text-muted mt-2" style="font-size: 0.9em;">
            <i class="pi pi-info-circle"></i> Selecciona un archivo Excel (.xlsx o .xls) para crear la nueva
            modificatoria
          </p>
        </div>

        <!-- File Selected Message -->
        <div class="file-selected mb-1"
          *ngIf="newModificationFile && !newModificationPreviewLoading && newModificationPreviewData.length === 0">
          <div class="alert alert-info"
            style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px;">
            <div style="display: flex; align-items: center;">
              <i class="pi pi-file" style="margin-right: 8px; color: #2196f3;"></i>
              <div>
                <strong>Archivo seleccionado:</strong> {{ newModificationFile.name }}
                <br>
                <small class="text-muted">Tamaño: {{ (newModificationFile.size / 1024 / 1024).toFixed(2) }} MB</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Preview Loading -->
        <div class="preview-loading text-center" *ngIf="newModificationPreviewLoading" style="padding: 20px;">
          <p-progressSpinner [style]="{'width': '40px', 'height': '40px'}"></p-progressSpinner>
          <p class="mt-3" style="font-size: 1.1em; font-weight: 500;">
            <strong>Cargando actividades para nueva modificatoria...</strong>
          </p>
          <p class="text-muted" style="font-size: 0.9em;">
            Procesando archivo Excel para mostrar vista previa
          </p>
        </div>

        <!-- Preview Data -->
        <div class="preview-data"
          *ngIf="!newModificationPreviewLoading && newModificationPreviewData.length > 0 && !newModificationLoading">
          <div class="alert alert-success my-3">
            <strong>✓ Archivo procesado correctamente</strong>
          </div>
          <h4>Vista Previa de Nueva Modificatoria</h4>
          <p class="text-muted mb-3">Se encontraron las siguientes dependencias y actividades:</p>

          <p-table [value]="newModificationPreviewData" [tableStyle]="{'min-width': '100%'}">
            <ng-template pTemplate="header">
              <tr>
                <th>Dependencia</th>
                <th class="text-center">Cantidad de Actividades</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>{{ item.dependencyName }}</td>
                <td class="text-center">{{ item.activityCount }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="summary">
              <div class="text-right">
                <strong>Total de actividades: {{ getTotalNewModificationActivities() }}</strong>
              </div>
            </ng-template>
          </p-table>
        </div>

        <!-- Import Progress -->
        <div class="import-progress text-center" *ngIf="newModificationLoading" style="padding: 20px;">
          <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
          <div class="mt-3">
            <div class="progress-bar-container" style="width: 100%; max-width: 550px; margin: 0 auto;">
              <div class="progress-bar"
                style="height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                <div style="height: 100%; background: #4caf50; transition: width 0.3s ease;"
                  [style.width.%]="newModificationProgress"></div>
              </div>
              <div class="mt-3" style="font-size: 1.1em; font-weight: 500;">
                <strong>Creando nueva modificatoria... {{newModificationProgress}}%</strong>
              </div>
              <div class="text-muted" style="font-size: 0.9em;">
                {{newModificationProcessed}} de {{newModificationTotal}} actividades procesadas
              </div>
              <div class="mt-2" style="font-size: 0.8em; color: #666; font-style: italic;">
                <i class="pi pi-shield" style="margin-right: 4px;"></i>
                Procesando actividades para la nueva modificatoria - No cerrar este diálogo
              </div>
            </div>
          </div>
        </div>

        <!-- No Data Message -->
        <div class="no-data text-center"
          *ngIf="!newModificationPreviewLoading && newModificationPreviewData.length === 0 && newModificationFile">
          <div class="alert alert-warning">
            <strong>⚠ No se encontraron datos válidos</strong>
            <p class="mb-0">El archivo seleccionado no contiene datos de actividades válidos.</p>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <ng-template pTemplate="footer">
        <div class="flex justify-content-between gap-2">
          <p-button label="Cancelar" icon="pi pi-times" severity="secondary" [disabled]="newModificationLoading"
            (click)="cancelNewModification()">
          </p-button>

          <div class="flex gap-2">
            <p-button label="Crear Nueva Modificatoria" icon="pi pi-check" severity="success"
              [disabled]="!newModificationFile || newModificationPreviewData.length === 0 || newModificationPreviewLoading || newModificationLoading"
              (click)="confirmNewModification()">
            </p-button>
          </div>
        </div>
      </ng-template>
    </p-dialog>
  </div>