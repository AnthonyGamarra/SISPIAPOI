<div>
  <!-- 1. Mostrar mensaje inicial cuando no se ha seleccionado nada -->
  <div *ngIf="!ano || !idDependency" class="text-center p-6">
    <h3 class="text-lg font-semibold text-gray-600">No se ha seleccionado una formulación</h3>
  </div>

  <!-- 2. Mostrar spinner mientras se está buscando la formulación -->
  <div *ngIf="(ano && idDependency) && (isLoadingFormulation || isSearchingFormulation)" class="text-center p-6">
    <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
    <p class="mt-3 text-gray-600">{{ isSearchingFormulation ? 'Buscando formulación...' : 'Verificando formulación...'
      }}</p>
  </div>

  <!-- 3.2 Mostrar mensaje cuando NO hay formulación (después de buscar) -->
  <div
    *ngIf="(ano && idDependency) && !currentFormulation && !isLoadingFormulation && !isSearchingFormulation && hasSearchedFormulation"
    class="text-center p-6">
    <h3 class="text-lg font-semibold text-gray-600">No se ha iniciado una formulación para el año: {{ ano }}</h3>
  </div>

  <!-- 3.1 Contenido principal cuando SÍ hay formulación -->
  <div *ngIf="currentFormulation">
    <div class="grid mx-auto my-3">
      <div class="col-12 md:col-8 flex justify-center mr-auto">
        <p-selectbutton class="size-buttons" [options]="sizes" [(ngModel)]="selectedSize" [multiple]="false"
          optionLabel="name" optionValue="value" />
      </div>
      <button *ngIf="currentFormulation?.dependency?.social" pButton label="Programación de prestaciones sociales"
        icon="pi pi-calendar" (click)="openPrestacionesSocialesModal()" class="col-6 md:col-2 add-button ml-auto"
        [disabled]="!currentFormulation || !ano">
      </button>
      <button pButton label="Agregar Actividad" icon="pi pi-plus" (click)="agregarActividad()"
        [disabled]="state === 2 || state === 4 || !year || !active" class="col-6 md:col-2 add-button ml-auto">
      </button>
    </div>

    <!-- Spinner de carga -->
    <div *ngIf="isLoadingActivities" class="text-center p-6">
      <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
      <p class="mt-3 text-gray-600">Cargando actividades...</p>
    </div>

    <!-- Mensaje cuando no hay actividades -->
    <div *ngIf="!isLoadingActivities && products.length === 0" class="text-center p-6">
      <h3 class="text-lg font-semibold text-gray-600">No hay actividades registradas</h3>
    </div>

    <!-- Tabla de actividades -->
    <div *ngIf="!isLoadingActivities && products.length > 0" class="table-container">
      <p-table #dataTable [value]="products" [size]="selectedSize" stripedRows showGridlines [resizableColumns]="true" columnResizeMode="expand"
        [scrollable]="true" columnResizeMode="expand" dataKey="idOperationalActivity"
        editMode="row" [paginator]="true" [rows]="8" [rowHover]="true" [editingRowKeys]="editingRowKeys">

        <ng-template pTemplate="header" class="table-header" #header>
          <tr class="cabecera">
            <th style="min-width: 120px; max-width: 120px;" rowspan="2">Acciones</th>

            <th style="min-width: 120px; max-width: 120px;" rowspan="2">Objetivo estratégico</th>
            <th style="min-width: 100px; max-width: 100px;" rowspan="2">Acción estratégica</th>

            <th style="min-width: 157px; max-width: 157px;" rowspan="2">Centro gestor</th>
            <th style="min-width: 220px; max-width: 220px;" rowspan="2">Centro de costos</th>
            <th style="min-width: 220px; max-width: 220px;" rowspan="2">Fondo financiero</th>

            <th style="min-width: 170px; max-width: 170px;" rowspan="2">Código de actividad</th>
            <th style="min-width: 320px; max-width: 320px;" rowspan="2">Nombre de actividad</th>
            <th style="min-width: 180px; max-width: 180px;" rowspan="2">Unidad de medida</th>


            <th style="min-width: 290px; max-width: 290px;" rowspan="2">Tipo de medida</th>
            <th style="min-width: 122px; max-width: 122px;" rowspan="2">Prioridad</th>

            <th colspan="5">Trimestre</th>
            <th colspan="4">Presupuesto S/.</th>

            <th style="min-width: 480px; max-width: 480px;" rowspan="2">Detalle de actividad</th>
          </tr>
          <tr class="cabecera">
            <th class="montos-cabecera" style="min-width: 110px; max-width: 110px;">I</th>
            <th class="montos-cabecera" style="min-width: 110px; max-width: 110px;">II</th>
            <th class="montos-cabecera" style="min-width: 110px; max-width: 110px;">III</th>
            <th class="montos-cabecera" style="min-width: 110px; max-width: 110px;">IV</th>
            <th class="montos-cabecera" style="min-width: 120px; max-width: 120px;">Total</th>
            <th class="montos-cabecera" style="min-width: 160px; max-width: 160px;">Remuneraciones</th>
            <th class="montos-cabecera" style="min-width: 160px; max-width: 160px;">Bienes</th>
            <th class="montos-cabecera" style="min-width: 160px; max-width: 160px;">Servicios</th>
            <th class="montos-cabecera" style="min-width: 170px; max-width: 170px;">Total</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex" #body>
          <tr [pEditableRow]="product">

            <td>
              <div class="flex justify-content-center gap-2">
                <button *ngIf="!editing && (state === 1 || state === 3) && active" pButton pRipple type="button"
                  pInitEditableRow icon="pi pi-pencil" (click)="onRowEditInit(product)" text rounded
                  severity="secondary">
                </button>

                <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check"
                  (click)="onRowEditSave(product)" text rounded severity="success">
                </button>

                <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times"
                  (click)="onRowEditCancel(product, ri)" text rounded severity="danger">
                </button>

                <button *ngIf="!editing && (state === 1 || state === 3) && active" pButton pRipple type="button"
                  icon="pi pi-trash" (click)="eliminarActividad(ri, product)" text rounded severity="danger">
                </button>
              </div>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <div class="flex items-center">
                    <input pInputText
                      [ngModel]="getStrategicObjectiveCodeDisplay(product.strategicAction?.strategicObjective?.idStrategicObjective)"
                      type="text" [disabled]="true" style="max-width: 80%" />
                    <button *ngIf="editing" pButton type="button" icon="pi pi-search"
                      (click)="openOeAeSelectionModal(product)" label=""
                      [disabled]="state === 2 || state === 4 || !active" class="p-button-sm ml-2">
                    </button>
                  </div>
                </ng-template>
                <ng-template pTemplate="output" class="text-output">
                  <span
                    [pTooltip]="getStrategicObjectiveName(product.strategicAction?.strategicObjective?.idStrategicObjective)">
                    {{
                    getStrategicObjectiveCodeDisplay(product.strategicAction?.strategicObjective?.idStrategicObjective)
                    }}
                  </span>
                </ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText
                    [ngModel]="getStrategicActionCodeDisplay(product.strategicAction?.idStrategicAction)" type="text"
                    [disabled]="true" />
                </ng-template>
                <ng-template pTemplate="output" class="text-output">
                  <span [pTooltip]="getStrategicActionName(product.strategicAction?.idStrategicAction)">
                    {{ getStrategicActionCodeDisplay(product.strategicAction?.idStrategicAction) }}
                  </span>
                </ng-template>
              </p-cellEditor>
            </td>

            <td style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select [options]="managementCenters" optionLabel="name" optionValue="idManagementCenter"
                    [ngModel]="getManagementCenterId(product)" (ngModelChange)="setManagementCenterId(product, $event)"
                    [style]="{ width: '100%', 'white-space': 'normal', 'word-wrap': 'break-word', 'overflow-wrap': 'break-word', 'height': 'auto', 'min-height': '2.5rem' }" 
                    [disabled]="state === 2 || state === 4 || !active" appendTo="body"
                    styleClass="multiline-select">
                  </p-select>
                </ng-template>
                <ng-template pTemplate="output" style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word; display: block;">
                  {{ getManagementCenterName(product.managementCenter?.idManagementCenter) }}
                </ng-template>
              </p-cellEditor>
            </td>

            <td style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select [options]="costCenters" optionLabel="name" optionValue="idCostCenter"
                    [ngModel]="getCostCenterId(product)" (ngModelChange)="setCostCenterId(product, $event)"
                    [style]="{ width: '100%', 'white-space': 'normal', 'word-wrap': 'break-word', 'overflow-wrap': 'break-word', 'height': 'auto', 'min-height': '2.5rem' }" 
                    [disabled]="state === 2 || state === 4 || !active" appendTo="body"
                    [filter]="true" filterBy="name"
                    styleClass="multiline-select">
                  </p-select>
                </ng-template>
                <ng-template pTemplate="output" style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word; display: block;">
                  {{ getCostCenterName(product.costCenter?.idCostCenter) }}
                </ng-template>
              </p-cellEditor>
            </td>

            <td style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word;">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select [options]="financialFunds" optionLabel="name" optionValue="idFinancialFund"
                    [ngModel]="getFinancialFundId(product)" (ngModelChange)="setFinancialFundId(product, $event)"
                    [style]="{ width: '100%', 'white-space': 'normal', 'word-wrap': 'break-word', 'overflow-wrap': 'break-word', 'height': 'auto', 'min-height': '2.5rem' }" 
                    [disabled]="state === 2 || state === 4 || !active" appendTo="body"
                    [filter]="true" filterBy="name"
                    styleClass="multiline-select">
                  </p-select>
                </ng-template>
                <ng-template pTemplate="output" style="white-space: normal; word-wrap: break-word; overflow-wrap: break-word; display: block;">
                  {{ getFinancialFundName(product.financialFund?.idFinancialFund) }}
                </ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.sapCode" type="text" [disabled]="true" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.sapCode }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <textarea rows="1" cols="35" [autoResize]="true" pTextarea [(ngModel)]="product.name"
                    [disabled]="state === 2 || state === 4 || !active || !product.active"
                    style="resize: none"></textarea>
                </ng-template>
                <ng-template pTemplate="output" class="text-output"><textarea rows="1" cols="35" [autoResize]="true"
                    pTextarea [disabled]="true" style="resize: none">{{ product.name }}</textarea></ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <textarea rows="1" cols="18" [autoResize]="true" pTextarea [(ngModel)]="product.measurementUnit"
                    [disabled]="state === 2 || state === 4 || !active || !product.active"
                    style="resize: none"></textarea>
                </ng-template>
                <ng-template pTemplate="output" class="text-output"><textarea rows="1" cols="18" [autoResize]="true"
                    pTextarea [disabled]="true"
                    style="resize: none">{{ product.measurementUnit }}</textarea></ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select [options]="measurementTypes" optionLabel="name" optionValue="idMeasurementType"
                    [ngModel]="getMeasurementTypeId(product)" (ngModelChange)="setMeasurementTypeId(product, $event)"
                    [style]="{ width: '100%' }" [disabled]="state === 2 || state === 4 || !active" appendTo="body">
                  </p-select>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ getMeasurementTypeName(product.measurementType?.idMeasurementType) }}
                </ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select [options]="priorities" optionLabel="name" optionValue="idPriority"
                    [ngModel]="getPriorityId(product)" (ngModelChange)="setPriorityId(product, $event)"
                    [style]="{ width: '100%' }" [disabled]="state === 2 || state === 4 || !active" appendTo="body">
                  </p-select>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ getPriorityName(product.priority?.idPriority) }}
                </ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.goals[0].value" type="number"
                    [disabled]="state === 2 || state === 4 || (quarter !== null && 1 < quarter) || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.goals[0]?.value | number:'1.0-0' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.goals[1].value" type="number"
                    [disabled]="state === 2 || state === 4 || (quarter !== null && 2 < quarter) || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.goals[1]?.value | number:'1.0-0' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.goals[2].value" type="number"
                    [disabled]="state === 2 || state === 4 || (quarter !== null && 3 < quarter) || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.goals[2]?.value | number:'1.0-0' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.goals[3].value" type="number"
                    [disabled]="state === 2 || state === 4 || (quarter !== null && 4 < quarter) || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.goals[3]?.value | number:'1.0-0' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <strong>{{ calculateQuarterlyTotalFromGoals(product) }}</strong>
                </ng-template>
                <ng-template pTemplate="output">
                  <strong>{{ calculateQuarterlyTotalFromGoals(product) | number:'1.0-0' }}</strong>
                </ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.remuneration" type="number" step="any"
                    [disabled]="state === 2 || state === 4 || !active || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.remuneration | number:'1.2-2' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.goods" type="number" step="any"
                    [disabled]="state === 2 || state === 4 || !active || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.goods | number:'1.2-2' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="product.services" type="number" step="any"
                    [disabled]="state === 2 || state === 4 || !active || !product.active" />
                </ng-template>
                <ng-template pTemplate="output">{{ product.services | number:'1.2-2' }}</ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input"><strong>{{ (product.goods + product.remuneration + product.services) |
                  number:'1.2-2' }}</strong></ng-template>
                <ng-template pTemplate="output"><strong>{{ (product.goods + product.remuneration + product.services) |
                  number:'1.2-2' }}</strong></ng-template>
              </p-cellEditor>
            </td>

            <td class="montos">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <textarea rows="3" cols="54" [autoResize]="false" pTextarea [(ngModel)]="product.description"
                    [disabled]="state === 2 || state === 4 || !active" style="resize: none"></textarea>
                </ng-template>
                <ng-template pTemplate="output" class="text-output">
                  <div class="description-container">
                    <textarea rows="2" cols="54" [autoResize]="false" pTextarea class="description-text" 
                      style="resize: none; overflow: hidden; text-align: justify; padding-left: 8px;" 
                      disabled>{{ getTruncatedDescription(product.description, 155) }}</textarea>
                    <button 
                      *ngIf="shouldShowViewMore(product.description, 155)" 
                      pButton 
                      type="button" 
                      icon="pi pi-eye"
                      label="Ver más" 
                      (click)="openDescriptionModal(product)" 
                      class="add-button"
                      style="padding: 0.25rem 3rem; font-size: 0.75rem;">
                    </button>
                  </div>
                </ng-template>
              </p-cellEditor>
            </td>

          </tr>
        </ng-template>
        
        <ng-template pTemplate="footer">
          <tr class="totals-row">
            <td></td> <!-- Acciones -->
            <td></td> <!-- Objetivo estratégico -->
            <td></td> <!-- Acción estratégica -->
            <td></td> <!-- Centro gestor -->
            <td></td> <!-- Centro de costos -->
            <td></td> <!-- Fondo financiero -->
            <td></td> <!-- Código de actividad -->
            <td></td> <!-- Nombre de actividad -->
            <td></td> <!-- Unidad de medida -->
            <td></td> <!-- Tipo de medida -->
            <td></td> <!-- Prioridad -->
            <td></td> <!-- Trimestre I -->
            <td></td> <!-- Trimestre II -->
            <td></td> <!-- Trimestre III -->
            <td></td> <!-- Trimestre IV -->
            <td></td> <!-- Total Trimestres -->
            <td class="montos total-cell"><strong>{{ getTotalRemuneraciones() | number:'1.2-2' }}</strong></td> <!-- Remuneraciones -->
            <td class="montos total-cell"><strong>{{ getTotalBienes() | number:'1.2-2' }}</strong></td> <!-- Bienes -->
            <td class="montos total-cell"><strong>{{ getTotalServicios() | number:'1.2-2' }}</strong></td> <!-- Servicios -->
            <td class="montos total-cell"><strong>{{ getTotalGeneral() | number:'1.2-2' }}</strong></td> <!-- Total -->
            <td></td> <!-- Detalle de actividad -->
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <p-dialog header="Seleccionar Objetivo y Acción Estratégica" [(visible)]="displayOeAeModal" [modal]="true"
    [resizable]="true" class="dialog-header" draggable="false">
    <div class="p-fluid p-grid">
      <div class="mt-5"> <label for="strategicObjective" class="font-semibold">Objetivo Estratégico:</label>
        <p-select id="strategicObjective" [options]="strategicObjectives" optionLabel="name"
          optionValue="idStrategicObjective" [(ngModel)]="tempSelectedStrategicObjectiveId"
          (onChange)="onModalStrategicObjectiveChange($event)" placeholder="Selecciona un objetivo" [filter]="true"
          filterBy="name" appendTo="body" class="w-full mt-5"> </p-select>
      </div>
      <div class="mt-5"> <label for="strategicAction" class="font-semibold">Acción Estratégica:</label>
        <p-select id="strategicAction" [options]="filteredStrategicActions" optionLabel="name"
          optionValue="idStrategicAction" [(ngModel)]="tempSelectedStrategicActionId"
          [disabled]="!tempSelectedStrategicObjectiveId" placeholder="Selecciona una acción" [filter]="true"
          filterBy="name" appendTo="body" class="w-full mt-5"> </p-select>
      </div>
    </div>
    <ng-template pTemplate="footer"> <button pButton label="Cancelar" icon="pi pi-times" (click)="cancelOeAeSelection()"
        styleClass="p-button-text" class="cancel-button"></button>
      <button pButton label="Seleccionar" icon="pi pi-check" (click)="confirmOeAeSelection()"
        class="mx-3 add-button"></button>
    </ng-template>
  </p-dialog>
  <p-dialog header="Confirmar Eliminación" [(visible)]="showDeleteConfirmation" [modal]="true"
    [style]="{ width: '30vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false"
    [resizable]="false" [baseZIndex]="10000" draggable="false">
    <div class="confirmation-content text-center">
      <div class="success-animation mb-0">
        <ng-lottie [options]="options"></ng-lottie>
      </div>
      <h3>¿Estás seguro de que quieres eliminar esta actividad?</h3>
      <p>Esta acción no se puede deshacer.</p>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer-buttons-wrapper">
        <button pButton label="No" icon="pi pi-times" (click)="cancelDelete()" class="custom-cancel-button mx-2">
        </button>
        <button pButton label="Sí" icon="pi pi-check" (click)="confirmDelete()" class="custom-confirm-button mx-2">
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de Descripción Completa -->
  <p-dialog [header]="'Detalle de actividad'" [(visible)]="displayDescriptionModal" 
    [modal]="true" [style]="{ width: '50vw', 'max-width': '800px' }" 
    [breakpoints]="{ '960px': '75vw', '640px': '90vw' }" [draggable]="true" [resizable]="true" 
    [baseZIndex]="10000">
    <div class="description-modal-content mt-3">
      <div class="description-full-text" style="white-space: pre-wrap; line-height: 1.5; padding: 1rem 1rem;">
        {{ selectedDescription }}
      </div>
    </div>
    <!-- <ng-template pTemplate="footer">
      <button pButton label="Cerrar" icon="pi pi-times" (click)="closeDescriptionModal()" 
        class="p-button-secondary">
      </button>
    </ng-template> -->
  </p-dialog>

  <!-- Subcomponente para Prestaciones Sociales -->
  <app-formulacion-sociales-tabla #socialesTabla [currentFormulation]="currentFormulation" [selectedSize]="selectedSize"
    [strategicObjectives]="strategicObjectives" [strategicActions]="strategicActions" [financialFunds]="financialFunds"
    [managementCenters]="managementCenters" [costCenters]="costCenters" [measurementTypes]="measurementTypes"
    [priorities]="priorities" (activitiesCreated)="onActivitiesCreatedFromConsolidated($event)">
  </app-formulacion-sociales-tabla>