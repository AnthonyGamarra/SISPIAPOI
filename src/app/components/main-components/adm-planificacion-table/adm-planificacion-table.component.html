<div class="adm-container mx-auto">
   <p-card>
      <div>
         <h2>Administración de Planificación</h2>
         <div class="grid">
            <div class="col-6">
               <span>Año:</span>
               <p-dropdown [options]="years" [(ngModel)]="selectedYear" (onChange)="onYearChange()"
                  placeholder="Seleccionar Año" [showClear]="false" class="mx-5"></p-dropdown>
            </div>
         </div>
      </div>

      <div *ngIf="getDependencyTypeNames().length === 0 && !canInitiateFormulation" class="p-text-center p-mt-5">
         <p>No hay formulaciones disponibles para el año {{selectedYear}}.</p>
      </div>

      <div *ngFor="let depTypeName of getDependencyTypeNames()">
         <p-fieldset [legend]="depTypeName" class="p-mt-4">
            <div class="flex justify-content-end flex-wrap gap-2">

               <button *ngIf="canInitiateFormulation && depTypeName === 'OOCC'" pButton
                  label="Iniciar Formulación para OOCC" icon="pi pi-plus" class="add-button"
                  (click)="onInitiateFormulationOC()">
               </button>

               <button *ngIf="!canInitiateFormulation && depTypeName === 'OOCC'" pButton
                  label="Nueva Modificatoria para OOCC" icon="pi pi-plus" class="add-button"
                  (click)="openNewModificationDialogOC()">
               </button>

            </div>
            <div *ngIf="!groupedFormulations[depTypeName] || Object.keys(groupedFormulations[depTypeName]).length === 0"
               class="p-text-center p-my-3">
               <p>No hay formulaciones para este tipo de dependencia para el año {{selectedYear}}.</p>
            </div>
            <!-- Loop through FormulationTypes for each DependencyType -->
            <div *ngFor="let formTypeName of getFormulationTypeNames(depTypeName)">
               <p-fieldset [legend]="formTypeName" class="p-mt-3" [collapsed]="false" [toggleable]="true"
                  *ngIf="formTypeName !== 'General'">

                  <div class="flex justify-content-end flex-wrap gap-2">

                     <button *ngIf="canInitiateFormulationOODD && depTypeName === 'OODD' &&  formTypeName === 'OODD ACTIVIDADES DE GESTIÓN'" pButton
                        label="Iniciar formulación de actividades de gestión" icon="pi pi-plus"
                        class="add-button" (click)="onInitiateFormulationOODD()">
                     </button>

                     <button *ngIf="!canInitiateFormulationOODD && depTypeName === 'OODD' &&  formTypeName === 'OODD ACTIVIDADES DE GESTIÓN'" pButton
                        label="Nueva Modificatoria de actividades de gestión" icon="pi pi-plus"
                        class="add-button" (click)="openNewModificationDialogOODD()">
                     </button>

                  </div>

                  <div *ngIf="!groupedFormulations[depTypeName][formTypeName] || 
                       Object.keys(groupedFormulations[depTypeName][formTypeName]).length === 0 ||
                       (getModificationNumbers(depTypeName, formTypeName).length === 1 && 
                        getFormulationsForGroup(depTypeName, formTypeName, 1).length === 0)"
                     class="p-text-center p-my-3">
                     <p>No hay formulaciones para este tipo de formulación para el año {{selectedYear}}.</p>
                  </div>

                  <div *ngFor="let modificationNum of getModificationNumbers(depTypeName, formTypeName)"
                     class="table-container">
                     <ng-container
                        *ngIf="getFormulationsForGroup(depTypeName, formTypeName, modificationNum).length > 0">
                        <h5 class="p-mt-3 p-mb-2">{{ modificationLabels[modificationNum] || 'Modificatoria Desconocida'
                           }}</h5>
                        <p-table [value]="getFormulationsForGroup(depTypeName, formTypeName, modificationNum)"
                           [paginator]="true" [rows]="10" [tableStyle]="{ 'max-width': '95vw' }" stripedRows
                           showGridlines>
                           <ng-template pTemplate="header">
                              <tr>
                                 <th class="centered">Dependencia</th>
                                 <th class="centered">Abierto desde</th>
                                 <th class="centered">Activo</th>
                              </tr>
                           </ng-template>
                           <ng-template pTemplate="body" let-formulation>
                              <tr>
                                 <td>{{ formulation.dependency?.name }}</td>
                                 <td class="centered">{{ quarterLabels[formulation.quarter!] }}</td>
                                 <td class="centered">
                                    <p-checkbox [(ngModel)]="formulation.active" [binary]="true"
                                       (onChange)="onActiveChange(formulation, $event)"></p-checkbox>
                                 </td>
                              </tr>
                           </ng-template>
                           <ng-template pTemplate="emptymessage">
                              <tr>
                                 <td colspan="3" class="p-text-center">No hay formulaciones en este grupo.</td>
                              </tr>
                           </ng-template>
                        </p-table>
                     </ng-container>
                  </div>
               </p-fieldset>

               <!-- For "General" (OC), display without inner fieldset -->
               <div *ngIf="formTypeName === 'General'">
                  <div *ngIf="!groupedFormulations[depTypeName][formTypeName] || 
                       Object.keys(groupedFormulations[depTypeName][formTypeName]).length === 0 ||
                       (getModificationNumbers(depTypeName, formTypeName).length === 1 && 
                        getFormulationsForGroup(depTypeName, formTypeName, 1).length === 0)"
                     class="p-text-center p-my-3">
                     <p>No hay formulaciones para este tipo de dependencia para el año {{selectedYear}}.</p>
                  </div>

                  <div *ngFor="let modificationNum of getModificationNumbers(depTypeName, formTypeName)"
                     class="table-container">
                     <ng-container
                        *ngIf="getFormulationsForGroup(depTypeName, formTypeName, modificationNum).length > 0">
                        <h4 class="p-mt-4 p-mb-2">{{ modificationLabels[modificationNum] || 'Modificatoria Desconocida'
                           }}</h4>
                        <p-table [value]="getFormulationsForGroup(depTypeName, formTypeName, modificationNum)"
                           [paginator]="true" [rows]="10" [tableStyle]="{ 'max-width': '95vw' }" stripedRows
                           showGridlines>
                           <ng-template pTemplate="header">
                              <tr>
                                 <th class="centered">Dependencia</th>
                                 <th class="centered">Abierto desde</th>
                                 <th class="centered">Activo</th>
                              </tr>
                           </ng-template>
                           <ng-template pTemplate="body" let-formulation>
                              <tr>
                                 <td>{{ formulation.dependency?.name }}</td>
                                 <td class="centered">{{ quarterLabels[formulation.quarter!] }}</td>
                                 <td class="centered">
                                    <p-checkbox [(ngModel)]="formulation.active" [binary]="true"
                                       (onChange)="onActiveChange(formulation, $event)"></p-checkbox>
                                 </td>
                              </tr>
                           </ng-template>
                           <ng-template pTemplate="emptymessage">
                              <tr>
                                 <td colspan="3" class="p-text-center">No hay formulaciones en este grupo.</td>
                              </tr>
                           </ng-template>
                        </p-table>
                     </ng-container>
                  </div>
               </div>
            </div>
         </p-fieldset>
      </div>
   </p-card>
</div>

<div class="success-animation" *ngIf="showSuccessAnimation">
   <ng-lottie [options]="options"></ng-lottie>
   <div class="message">Formulación iniciada correctamente</div>
</div>


<p-dialog header="Nueva Modificatoria para OOCC" [(visible)]="displayNewModificationDialog" [modal]="true"
   [style]="{width: '35vw'}" [breakpoints]="{ '960px': '80vw', '640px': '95vw' }" [draggable]="false"
   [resizable]="false">
   <div class="p-fluid">
      <div class="p-field">
         <label for="newQuarter" class="mr-8 lg:mr-8">Abierto desde:</label>
         <p-dropdown id="newQuarter" [options]="quarterOptions" [(ngModel)]="newModificationQuarter" optionLabel="label"
            optionValue="value" placeholder="Trimestre" [showClear]="false" appendTo="body" class="ml-6 lg:ml-8">
         </p-dropdown>
      </div>
   </div>

   <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" styleClass="p-button-text"
         (click)="displayNewModificationDialog = false" class="cancel-button"></button>
      <button pButton label="Crear" icon="pi pi-check" (click)="addNewModificationOC()" class="add-button"></button>
   </ng-template>
</p-dialog>

<p-dialog header="Nueva Modificatoria de Actividades de Gestión OODD" [(visible)]="displayNewModificationDialogOODD" [modal]="true"
   [style]="{width: '35vw'}" [breakpoints]="{ '960px': '80vw', '640px': '95vw' }" [draggable]="false"
   [resizable]="false">
   <div class="p-fluid">
      <div class="p-field">
         <label for="newQuarterOODD" class="mr-8 lg:mr-8">Abierto desde:</label>
         <p-dropdown id="newQuarterOODD" [options]="quarterOptions" [(ngModel)]="newModificationQuarterOODD" optionLabel="label"
            optionValue="value" placeholder="Trimestre" [showClear]="false" appendTo="body" class="ml-6 lg:ml-8">
         </p-dropdown>
      </div>
   </div>

   <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" styleClass="p-button-text"
         (click)="displayNewModificationDialogOODD = false" class="cancel-button"></button>
      <button pButton label="Crear" icon="pi pi-check" (click)="addNewModificationOODD()" class="add-button"></button>
   </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>