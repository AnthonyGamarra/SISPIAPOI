<div class="mx-5">
  <div class="grid ml-auto mt-3">
    <h2 class="col-auto">Administrar Maestros - IPRESS</h2>
  </div>

  <!-- Spinner de carga -->
  <div *ngIf="loading" class="text-center p-6">
    <p-progressSpinner [style]="{ width: '50px', height: '50px' }" strokeWidth="4"></p-progressSpinner>
    <p class="mt-3 text-gray-600">Cargando datos...</p>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!loading" class="mb-3">
    <!-- Top grid: Levels and Complexities side-by-side -->
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="title-section flex justify-content-between align-items-center my-4">
          <h3 class="text-xl font-semibold m-0">Gestión de Niveles</h3>
          <button pButton label="Agregar Nivel" icon="pi pi-plus" class="add-uo-button" (click)="addNewLevelRow()"></button>
        </div>
        <div class="table-container" style="height: 450px; overflow: hidden; display: flex; flex-direction: column;">
          <p-table #levelsTable
                   [value]="levels"
                   showGridlines
                   stripedRows
                   dataKey="idIpressLevel"
                   editMode="row"
                   [rowHover]="true"
                   [editingRowKeys]="editingLevelRowKeys"
                   [paginator]="true"
                   [rows]="levelRowsPerPage"
                   [(first)]="levelFirst"
                   [style]="{ 'flex': '1 1 auto' }"
          >
            <ng-template pTemplate="header">
              <tr class="cabecera">
                <th style="min-width: 120px; max-width: 120px;">Acciones</th>
                <th style="min-width: 240px;">Nombre</th>
                <th style="min-width: 240px;">Descripción</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row let-editing="editing" let-ri="rowIndex">
              <tr [pEditableRow]="row">
                <td>
                  <div class="flex justify-content-center gap-2">
                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" (click)="onLevelRowEditInit(row)" text rounded severity="secondary"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check" (click)="onLevelRowEditSave(row)" text rounded severity="success"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" (click)="onLevelRowEditCancel(row, ri)" text rounded severity="danger"></button>
                    <button *ngIf="!editing" pButton pRipple type="button" icon="pi pi-trash" (click)="eliminarLevelRow(row)" text rounded severity="danger"></button>
                  </div>
                </td>
                <td>
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input pInputText [(ngModel)]="row.name" type="text" style="width: 100%;" />
                    </ng-template>
                    <ng-template pTemplate="output">{{ row.name }}</ng-template>
                  </p-cellEditor>
                </td>
                <td>
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input pInputText [(ngModel)]="row.description" type="text" style="width: 100%;" />
                    </ng-template>
                    <ng-template pTemplate="output">{{ row.description }}</ng-template>
                  </p-cellEditor>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <div class="col-12 md:col-6">
        <div class="title-section flex justify-content-between align-items-center my-4">
          <h3 class="text-xl font-semibold m-0">Gestión de Complejidad</h3>
          <button pButton label="Agregar Complejidad" icon="pi pi-plus" class="add-uo-button" (click)="addNewComplexityRow()"></button>
        </div>
        <div class="table-container" style="height: 380px; overflow: hidden; display: flex; flex-direction: column;">
          <p-table #complexitiesTable
                   [value]="complexities"
                   showGridlines
                   stripedRows
                   dataKey="idIpressComplexity"
                   editMode="row"
                   [rowHover]="true"
                   [editingRowKeys]="editingComplexityRowKeys"
                   [paginator]="true"
                   [rows]="complexityRowsPerPage"
                   [(first)]="complexityFirst"
                   [style]="{ 'flex': '1 1 auto' }"
          >
            <ng-template pTemplate="header">
              <tr class="cabecera">
                <th style="min-width: 120px; max-width: 120px;">Acciones</th>
                <th style="min-width: 240px;">Nombre</th>
                <th style="min-width: 240px;">Descripción</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row let-editing="editing" let-ri="rowIndex">
              <tr [pEditableRow]="row">
                <td>
                  <div class="flex justify-content-center gap-2">
                    <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow icon="pi pi-pencil" (click)="onComplexityRowEditInit(row)" text rounded severity="secondary"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow icon="pi pi-check" (click)="onComplexityRowEditSave(row)" text rounded severity="success"></button>
                    <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow icon="pi pi-times" (click)="onComplexityRowEditCancel(row, ri)" text rounded severity="danger"></button>
                    <button *ngIf="!editing" pButton pRipple type="button" icon="pi pi-trash" (click)="eliminarComplexityRow(row)" text rounded severity="danger"></button>
                  </div>
                </td>
                <td>
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input pInputText [(ngModel)]="row.name" type="text" style="width: 100%;" />
                    </ng-template>
                    <ng-template pTemplate="output">{{ row.name }}</ng-template>
                  </p-cellEditor>
                </td>
                <td>
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <input pInputText [(ngModel)]="row.description" type="text" style="width: 100%;" />
                    </ng-template>
                    <ng-template pTemplate="output">{{ row.description }}</ng-template>
                  </p-cellEditor>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>

    <div class="title-section flex justify-content-between align-items-center my-4">
      <h3 class="text-xl font-semibold m-0">Gestión de IPRESS</h3>
      <button pButton label="Agregar IPRESS" icon="pi pi-plus" class="add-uo-button" (click)="addNewRow()"></button>
    </div>

    <div class="table-container">
      <p-table
        #ipressTable
        [value]="ipresses"
        stripedRows
        showGridlines
        [resizableColumns]="true"
        [scrollable]="true"
        scrollHeight="480px"
        columnResizeMode="expand"
        dataKey="idIpress"
        editMode="row"
        [paginator]="true"
        [rows]="10"
        [rowHover]="true"
        [editingRowKeys]="editingRowKeys"
      >
        <ng-template pTemplate="header">
          <tr class="cabecera">
            <th style="min-width: 120px; max-width: 120px;">Acciones</th>
            <th style="min-width: 120px; max-width: 160px;">Código</th>
            <th style="min-width: 320px;">Nombre</th>
            <th style="min-width: 200px;">Nivel</th>
            <th style="min-width: 200px;">Complejidad</th>
            <th style="min-width: 260px;">Dependencia</th>
            <th style="min-width: 120px;">Estado</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-row let-editing="editing" let-ri="rowIndex">
          <tr [pEditableRow]="row">
            <td>
              <div class="flex justify-content-center gap-2">
                <button
                  *ngIf="!editing"
                  pButton
                  pRipple
                  type="button"
                  pInitEditableRow
                  icon="pi pi-pencil"
                  (click)="onRowEditInit(row)"
                  text
                  rounded
                  severity="secondary"
                ></button>

                <button
                  *ngIf="editing"
                  pButton
                  pRipple
                  type="button"
                  pSaveEditableRow
                  icon="pi pi-check"
                  (click)="onRowEditSave(row)"
                  text
                  rounded
                  severity="success"
                ></button>

                <button
                  *ngIf="editing"
                  pButton
                  pRipple
                  type="button"
                  pCancelEditableRow
                  icon="pi pi-times"
                  (click)="onRowEditCancel(row, ri)"
                  text
                  rounded
                  severity="danger"
                ></button>

                <button
                  *ngIf="!editing"
                  pButton
                  pRipple
                  type="button"
                  icon="pi pi-trash"
                  (click)="eliminarRow(row)"
                  text
                  rounded
                  severity="danger"
                ></button>
              </div>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="row.code" type="text" maxlength="4" (input)="onCodeInput(row, $event)" />
                </ng-template>
                <ng-template pTemplate="output">{{ row.code }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <input pInputText [(ngModel)]="row.name" type="text" style="width: 100%;" />
                </ng-template>
                <ng-template pTemplate="output">{{ row.name }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select
                    [options]="levels"
                    optionLabel="name"
                    optionValue="idIpressLevel"
                    [ngModel]="row.ipressLevel?.idIpressLevel"
                    (ngModelChange)="onLevelChange(row, $event)"
                    placeholder="Selecciona nivel"
                    [filter]="true"
                    appendTo="body"
                    class="w-full"
                  ></p-select>
                </ng-template>
                <ng-template pTemplate="output">{{ row.ipressLevel?.name }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select
                    [options]="complexities"
                    optionLabel="name"
                    optionValue="idIpressComplexity"
                    [ngModel]="row.ipressComplexity?.idIpressComplexity"
                    (ngModelChange)="onComplexityChange(row, $event)"
                    placeholder="Selecciona complejidad"
                    [filter]="true"
                    appendTo="body"
                    class="w-full"
                  ></p-select>
                </ng-template>
                <ng-template pTemplate="output">{{ row.ipressComplexity?.name }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-select
                    [options]="dependencies"
                    optionLabel="name"
                    optionValue="idDependency"
                    [ngModel]="row.dependency?.idDependency"
                    (ngModelChange)="onDependencyChange(row, $event)"
                    placeholder="Selecciona dependencia"
                    [filter]="true"
                    appendTo="body"
                    class="w-full"
                  ></p-select>
                </ng-template>
                <ng-template pTemplate="output">{{ row.dependency?.name }}</ng-template>
              </p-cellEditor>
            </td>

            <td>
              <p-tag [value]="getStatusText(row.active)" [severity]="getSeverity(row.active)"></p-tag>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Modal de confirmación de eliminación -->
  <p-dialog
    header="Confirmar Eliminación"
    [(visible)]="showDeleteConfirmation"
    [modal]="true"
    [style]="{ width: '30vw' }"
    [breakpoints]="{ '960px': '80vw', '640px': '80vw' }"
    [draggable]="false"
    [resizable]="false"
    [baseZIndex]="10000"
  >
    <div class="confirmation-content text-center">
      <h3>¿Estás seguro de que quieres eliminar esta IPRESS?</h3>
      <p>Esta acción no se puede deshacer.</p>
      <div *ngIf="loading" class="mt-3">
        <p-progressSpinner [style]="{ width: '40px', height: '40px' }" strokeWidth="4"></p-progressSpinner>
        <p class="mt-2">Procesando eliminación, por favor espere...</p>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer-buttons-wrapper">
        <button pButton label="No" icon="pi pi-times" (click)="cancelDelete()" class="custom-cancel-button mx-2" [disabled]="loading"></button>
        <button pButton label="Sí" icon="pi pi-check" (click)="confirmDelete()" class="custom-confirm-button mx-2" [disabled]="loading"></button>
      </div>
    </ng-template>
  </p-dialog>
</div>

<!-- Dialogs for Level and Complexity Deletion -->
<p-dialog header="Confirmar Eliminación de Nivel" [(visible)]="showDeleteLevelConfirmation" [modal]="true" [style]="{ width: '30vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false" [resizable]="false" [baseZIndex]="10000">
  <div class="confirmation-content text-center">
    <h3>¿Eliminar nivel seleccionado?</h3>
    <p>Esta acción no se puede deshacer.</p>
  </div>
  <ng-template pTemplate="footer">
    <div class="dialog-footer-buttons-wrapper">
      <button pButton label="No" icon="pi pi-times" (click)="cancelDeleteLevel()" class="custom-cancel-button mx-2" [disabled]="loading"></button>
      <button pButton label="Sí" icon="pi pi-check" (click)="confirmDeleteLevel()" class="custom-confirm-button mx-2" [disabled]="loading"></button>
    </div>
  </ng-template>
</p-dialog>

<p-dialog header="Confirmar Eliminación de Complejidad" [(visible)]="showDeleteComplexityConfirmation" [modal]="true" [style]="{ width: '30vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false" [resizable]="false" [baseZIndex]="10000">
  <div class="confirmation-content text-center">
    <h3>¿Eliminar complejidad seleccionada?</h3>
    <p>Esta acción no se puede deshacer.</p>
  </div>
  <ng-template pTemplate="footer">
    <div class="dialog-footer-buttons-wrapper">
      <button pButton label="No" icon="pi pi-times" (click)="cancelDeleteComplexity()" class="custom-cancel-button mx-2" [disabled]="loading"></button>
      <button pButton label="Sí" icon="pi pi-check" (click)="confirmDeleteComplexity()" class="custom-confirm-button mx-2" [disabled]="loading"></button>
    </div>
  </ng-template>
</p-dialog>