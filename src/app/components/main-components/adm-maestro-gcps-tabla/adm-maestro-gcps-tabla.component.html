<div>
  <div class="mx-5">
    <div class="grid ml-auto mt-3">
      <h2 class="col-auto">
        Administrar Maestros - {{ currentFormulationType?.name }} del año:
      </h2>
      <span class="col-auto my-auto">
        <p-select [options]="years" [(ngModel)]="selectedYear" (onChange)="onYearChange()" placeholder="Seleccionar Año"
          [showClear]="false" class="mx-2"></p-select>
      </span>
      <span class="col-auto my-auto">
        <p-select [options]="modificationOptions" optionLabel="label" optionValue="value" 
          [(ngModel)]="selectedModification" (onChange)="onModificationChange()" 
          placeholder="Seleccionar Etapa" [showClear]="false" class="mx-2"></p-select>
      </span>
      <span class="col-auto my-auto">
        <button pButton label="Exportar Plantilla" icon="pi pi-download" 
          class="p-button-outlined p-button-success mx-2" 
          (click)="exportHealthActivityTemplate()"
          title="Descargar plantilla Excel para actividades de salud">
        </button>
        <button pButton label="Importar Plantilla" icon="pi pi-upload" 
          class="p-button-outlined p-button-primary mx-2" 
          (click)="onImportTemplateClick()"
          title="Importar actividades desde plantilla Excel">
        </button>
      </span>
    </div>

    <!-- Spinner de carga -->
    <div *ngIf="loading" class="text-center p-6">
      <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
      <p class="mt-3 text-gray-600">Cargando datos...</p>
    </div>

    <!-- Progreso de importación de actividades - REMOVIDO DEL COMPONENTE PRINCIPAL -->

    <!-- Tabla de actividades por dependency -->
    <div *ngIf="!loading" class="mt-4">
      <h3 class="mb-3">Actividades por Dependencia - {{selectedYear}} - {{getModificationLabel(selectedModification)}}</h3>
      <p-table [value]="activitiesByDependency" dataKey="dependencyName" 
               [tableStyle]="{'min-width': '50rem'}" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Dependencia</th>
            <th>Cantidad de Actividades</th>
            <th>Estado</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{item.dependencyName}}</td>
            <td class="text-center">{{item.activityCount}}</td>
            <td>
              <p-tag *ngIf="item.hasFormulation" value="Formulación iniciada" severity="success"></p-tag>
              <span *ngIf="!item.hasFormulation" class="text-muted">
                No se ha iniciado la formulación para {{item.dependencyName}} para el año {{selectedYear}}
              </span>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="3" class="text-center">No hay dependencias configuradas</td>
          </tr>
        </ng-template>
      </p-table>
    </div>


  </div>

  <!-- Modal para seleccionar Objetivo y Acción Estratégica -->
  <p-dialog header="Seleccionar Objetivo y Acción Estratégica" [(visible)]="displayOeAeModal" [modal]="true"
    [resizable]="true" class="dialog-header" draggable="false">
    <div class="p-fluid p-grid">
      <div class="mt-5">
        <label for="strategicObjective" class="font-semibold">Objetivo Estratégico:</label>
        <p-select id="strategicObjective" [options]="strategicObjectives" optionLabel="name"
          optionValue="idStrategicObjective" [(ngModel)]="tempSelectedStrategicObjectiveId"
          (onChange)="onModalStrategicObjectiveChange($event)" placeholder="Selecciona un objetivo" [filter]="true"
          filterBy="name" appendTo="body" class="w-full mt-5">
        </p-select>
      </div>
      <div class="mt-5">
        <label for="strategicAction" class="font-semibold">Acción Estratégica:</label>
        <p-select id="strategicAction" [options]="filteredStrategicActions" optionLabel="name"
          optionValue="idStrategicAction" [(ngModel)]="tempSelectedStrategicActionId"
          [disabled]="!tempSelectedStrategicObjectiveId" placeholder="Selecciona una acción" [filter]="true"
          filterBy="name" appendTo="body" class="w-full mt-5">
        </p-select>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <button pButton label="Cancelar" icon="pi pi-times" (click)="cancelOeAeSelection()" styleClass="p-button-text"
        class="cancel-button">
      </button>
      <button pButton label="Seleccionar" icon="pi pi-check" (click)="confirmOeAeSelection()" class="mx-3 add-button">
      </button>
    </ng-template>
  </p-dialog>

  <!-- Modal de confirmación de eliminación -->
  <p-dialog header="Confirmar Eliminación" [(visible)]="showDeleteConfirmation" [modal]="true"
    [style]="{ width: '30vw' }" [breakpoints]="{ '960px': '80vw', '640px': '80vw' }" [draggable]="false"
    [resizable]="false" [baseZIndex]="10000" draggable="false">
    <div class="confirmation-content text-center">
      <h3>¿Estás seguro de que quieres eliminar esta actividad?</h3>
      <p>Esta acción no se puede deshacer.</p>
    </div>
    <ng-template pTemplate="footer">
      <div class="dialog-footer-buttons-wrapper">
        <button pButton label="No" icon="pi pi-times" (click)="cancelDelete()" class="custom-cancel-button mx-2">
        </button>
        <button pButton label="Sí" icon="pi pi-check" (click)="confirmDelete()" class="custom-confirm-button mx-2">
        </button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal para replicar actividades -->
  <!-- <p-dialog header="Replicar Actividades de Gestión" [(visible)]="showReplicateDialog" [modal]="true"
    [style]="{width: '35vw'}" [breakpoints]="{ '960px': '80vw', '640px': '95vw' }" draggable="false">
    <div class="p-field my-3">
      <label>Selecciona el año destino: </label>
      <p-select [options]="yearOptions" [(ngModel)]="replicateYear" optionLabel="label" optionValue="value"
        placeholder="Selecciona un año" [showClear]="false" class="w-full mt-2" appendTo="body">
      </p-select>
    </div>
    <div class="p-mt-3 flex justify-content-end gap-2 my-3">
      <button pButton label="Replicar" icon="pi pi-copy" (click)="replicateActivities()"
        [disabled]="!replicateYear || replicateYear === selectedYear" class="p-button-warning"></button>
      <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text"
        (click)="showReplicateDialog=false"></button>
    </div>
  </p-dialog> -->

<!-- Import Preview Modal -->
<p-dialog 
  [(visible)]="showImportPreviewModal" 
  header="Vista Previa de Importación" 
  [modal]="true" 
  [closable]="false"
  [style]="{width: '600px'}"
  [draggable]="false" 
  [resizable]="false">
  
  <div class="import-preview-content">
    <!-- File Selection -->
    <div class="file-section mb-4" *ngIf="!importFile">
      <h5>Seleccionar Archivo Excel</h5>
      <input 
        type="file" 
        accept=".xlsx,.xls" 
        (change)="onFileChange($event)"
        class="form-control"
        style="padding: 10px; border: 2px dashed #ccc; border-radius: 5px; width: 100%;">
      <p class="text-muted mt-2" style="font-size: 0.9em;">
        <i class="pi pi-info-circle"></i> Selecciona un archivo Excel (.xlsx o .xls)
      </p>
    </div>

    <!-- File Selected Message -->
    <div class="file-selected mb-4" *ngIf="importFile && !previewLoading && importPreviewData.length === 0">
      <div class="alert alert-info" style="background-color: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px;">
        <div style="display: flex; align-items: center;">
          <i class="pi pi-file" style="margin-right: 8px; color: #2196f3;"></i>
          <div>
            <strong>Archivo seleccionado:</strong> {{ importFile.name }}
            <br>
            <small class="text-muted">Tamaño: {{ (importFile.size / 1024 / 1024).toFixed(2) }} MB</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Loading -->
    <div class="preview-loading text-center" *ngIf="previewLoading" style="padding: 20px;">
      <p-progressSpinner [style]="{'width': '40px', 'height': '40px'}"></p-progressSpinner>
      <p class="mt-3" style="font-size: 1.1em; font-weight: 500;">
        <strong>Cargando actividades...</strong>
      </p>
      <p class="text-muted" style="font-size: 0.9em;">
        Procesando archivo Excel para mostrar vista previa
      </p>
    </div>

    <!-- Preview Data -->
    <div class="preview-data" *ngIf="!previewLoading && importPreviewData.length > 0 && !importLoading">
      <div class="alert alert-success mb-3">
        <strong>✓ Archivo procesado correctamente</strong>
      </div>
      <h5>Vista Previa de Importación</h5>
      <p class="text-muted mb-3">Se encontraron las siguientes dependencias y actividades:</p>
      
      <p-table [value]="importPreviewData" [tableStyle]="{'min-width': '100%'}">
        <ng-template pTemplate="header">
          <tr>
            <th>Dependencia</th>
            <th class="text-center">Cantidad de Actividades</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>{{ item.dependencyName }}</td>
            <td class="text-center">{{ item.activityCount }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="summary">
          <div class="text-right">
            <strong>Total de actividades: {{ getTotalActivities() }}</strong>
          </div>
        </ng-template>
      </p-table>
    </div>

    <!-- Import Progress - DENTRO DEL MODAL -->
    <div class="import-progress text-center" *ngIf="importLoading" style="padding: 20px;">
      <p-progressSpinner [style]="{'width': '50px', 'height': '50px'}" strokeWidth="4"></p-progressSpinner>
      <div class="mt-3">
        <div class="progress-bar-container" style="width: 100%; max-width: 400px; margin: 0 auto;">
          <div class="progress-bar" style="height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
            <div style="height: 100%; background: #4caf50; transition: width 0.3s ease;" [style.width.%]="importProgress"></div>
          </div>
          <div class="mt-3" style="font-size: 1.1em; font-weight: 500;">
            <strong>Importando actividades... {{importProgress}}%</strong>
          </div>
          <div class="text-muted" style="font-size: 0.9em;">
            {{importProcessed}} de {{importTotal}} actividades procesadas
          </div>
        </div>
      </div>
    </div>

    <!-- No Data Message -->
    <div class="no-data text-center" *ngIf="!previewLoading && importPreviewData.length === 0 && importFile">
      <div class="alert alert-warning">
        <strong>⚠ No se encontraron datos válidos</strong>
        <p class="mb-0">El archivo seleccionado no contiene datos de actividades válidos.</p>
      </div>
    </div>
  </div>

  <!-- Modal Footer -->
  <ng-template pTemplate="footer">
    <div class="flex justify-content-between">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [disabled]="importLoading"
        (click)="cancelImport()">
      </p-button>
      
      <div class="flex gap-2">
        <p-button 
          label="Seleccionar Otro Archivo" 
          icon="pi pi-file" 
          severity="info"
          *ngIf="importFile && !importLoading"
          (click)="resetFileSelection()">
        </p-button>
        
        <p-button 
          label="Confirmar Importación" 
          icon="pi pi-check" 
          severity="success"
          [disabled]="!importFile || importPreviewData.length === 0 || previewLoading || importLoading"
          (click)="confirmImport()">
        </p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

</div>